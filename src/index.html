<!DOCTYPE html>
<html>
<head>
    <title>Configuration Page</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
    <style>
        /* Custom styles */
        .config-container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .days-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .days-container label {
            flex: 1;
            text-align: center;
        }
        .time-slot {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 8px;
        }
        .time-slot input[type="text"],
        .time-slot input[type="number"] {
            flex-grow: 1;
            margin-left: 8px;
        }
        .delete-time-button {
            margin-left: 8px;
        }

        /* Media queries for responsiveness */
        @media (max-width: 576px) {
            .config-container {
                padding: 8px;
            }
            .time-slot {
                flex-wrap: wrap;
            }
            .time-slot input[type="text"],
            .time-slot input[type="number"] {
                flex-basis: 100%;
                margin-left: 0;
                margin-top: 8px;
            }
            .delete-time-button {
                margin-left: 0;
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="config-container">
        <h1>Configuration Page</h1>

        <form id="configForm">
            <h2>Days:</h2>
            <div class="days-container">
                <label>
                    <input class="form-check-input" type="checkbox" name="day" value="0" id="mondayCheck">
                    Mon
                </label>
                <label>
                    <input class="form-check-input" type="checkbox" name="day" value="1" id="tuesdayCheck">
                    Tue
                </label>
                <label>
                    <input class="form-check-input" type="checkbox" name="day" value="2" id="wednesdayCheck">
                    Wed
                </label>
                <label>
                    <input class="form-check-input" type="checkbox" name="day" value="3" id="thursdayCheck">
                    Thu
                </label>
                <label>
                    <input class="form-check-input" type="checkbox" name="day" value="4" id="fridayCheck">
                    Fri
                </label>
                <label>
                    <input class="form-check-input" type="checkbox" name="day" value="5" id="saturdayCheck">
                    Sat
                </label>
                <label>
                    <input class="form-check-input" type="checkbox" name="day" value="6" id="sundayCheck">
                    Sun
                </label>
            </div>

            <h2>Times:</h2>
            <div id="timesContainer"></div>

            <div class="mb-3">
                <button type="button" id="addTimeButton" class="btn btn-secondary">Add Time</button>
                <div style="width: 100%; margin-top: 5px;">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Add Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to add a time input field
        function addTimeInput() {
            const timesContainer = document.getElementById("timesContainer");

            const timeInput = document.createElement("div");
            timeInput.className = "time-slot";
            timeInput.innerHTML = `
                <label>
                    Start Time:
                    <input type="text" name="startTime" required class="form-control">
                </label>
                <label>
                    Duration (seconds):
                    <input type="number" name="durationSeconds" required class="form-control">
                </label>
                <button type="button" class="delete-time-button btn btn-danger btn-sm">
                    Delete
                </button>
            `;

            const deleteButton = timeInput.querySelector(".delete-time-button");
            deleteButton.addEventListener("click", function () {
                timesContainer.removeChild(timeInput);
            });

            timesContainer.appendChild(timeInput);
        }

        // Event listener to dynamically add time input fields
        document.getElementById("configForm").addEventListener("submit", function (event) {
            event.preventDefault();
        });

        document.getElementById("addTimeButton").addEventListener("click", function () {
            addTimeInput();
        });

        // Function to generate the config object from the form values
        function generateConfig() {
            const config = {
                days: [false, false, false, false, false, false, false],
                times: []
            };

            const dayCheckboxes = document.getElementsByName("day");
            for (const checkbox of dayCheckboxes) {
                if (checkbox.checked) {
                    const dayIndex = parseInt(checkbox.value);
                    config.days[dayIndex] = true;
                }
            }

            const startTimeInputs = document.getElementsByName("startTime");
            const durationInputs = document.getElementsByName("durationSeconds");

            for (let i = 0; i < startTimeInputs.length; i++) {
                const startTime = startTimeInputs[i].value.trim();
                const duration = parseInt(durationInputs[i].value);

                if (startTime && duration) {
                    config.times.push({ start: startTime, durationSeconds: duration });
                }
            }

            return config;
        }

        // Example usage: log the generated config object when the form is submitted
        document.getElementById("configForm").addEventListener("submit", function (event) {
            const config = generateConfig();
            console.log(config);
            uploadConfig(config);
        });

        // Function to load an existing config
        function loadConfig(existingConfig) {
            const dayCheckboxes = document.getElementsByName("day");
            for (let i = 0; i < dayCheckboxes.length; i++) {
                const dayCheckbox = dayCheckboxes[i];
                dayCheckbox.checked = existingConfig.days[i];
            }

            const timesContainer = document.getElementById("timesContainer");
            for (let i = 0; i < existingConfig.times.length; i++) {
                const time = existingConfig.times[i];

                const timeInput = document.createElement("div");
                timeInput.className = "time-slot";
                timeInput.innerHTML = `
                    <label>
                        Start Time:
                        <input type="text" name="startTime" required class="form-control" value="${time.start}">
                    </label>
                    <label>
                        Duration (seconds):
                        <input type="number" name="durationSeconds" required class="form-control" value="${time.durationSeconds}">
                    </label>
                    <button type="button" class="delete-time-button btn btn-danger btn-sm">
                        Delete
                    </button>
                `;

                const deleteButton = timeInput.querySelector(".delete-time-button");
                deleteButton.addEventListener("click", function () {
                    timesContainer.removeChild(timeInput);
                });

                timesContainer.appendChild(timeInput);
            }
        }

        const fetchConfig = () => {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    loadConfig(data);
                });
        }

        const uploadConfig = (config) => {
            fetch('/config', {
                method: 'POST',
                body: JSON.stringify(config),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .catch(err => {
                console.error(err);
            })
        }

        // // Example usage: load an existing config
        // const existingConfig = {
        //     days: [true, true, true, true, true, true, true],
        //     times: [
        //         {
        //             start: "0940",
        //             durationSeconds: 20
        //         },
        //         {
        //             start: "0947",
        //             durationSeconds: 60
        //         },
        //         {
        //             start: "0950",
        //             durationSeconds: 120
        //         },
        //     ]
        // };
        fetchConfig();
    </script>
</body>
</html>
